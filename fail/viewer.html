<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>ARTificial INTELLIGENCE FAIL - Failed Art by AI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Failed AI generated art from AI generated descriptions of art.">
		<meta name="keywords" content="fail, AI, artificial intelligence, art, illustrations, painting">
		<meta name="generator" content="handmade">
	
		<link rel="apple-touch-icon" sizes="57x57" href="/assets/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/assets/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/assets/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/assets/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/assets/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/assets/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/assets/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/assets/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="/assets/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
	<!-- 
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#000000">
	 -->
		<meta name="apple-mobile-web-app-title" content="ART Int">
		<meta name="application-name" content="ART Int">
		<style>
			html {
				font-family: sans-serif;
				font-size: 16px;
			}
			@media (min-width: 1023px) {
				html { --hscale: 1.1; }
			}
			@media (min-width: 1279px) {
				html { --hscale: 1.2; }
			}
			@media (min-width: 1439px) {
				html { --hscale: 1.4; }
			}
			@media (min-width: 1919px) {
				html { --hscale: 1.6; }
			}
			@media (min-width: 2879px) {
				html { --hscale: 2.0; }
			}
			
			html {
				font-size: calc(var(--hscale) * 1rem);
				--displayHeightSmall: 5.0rem;
				--displayHeightLarge: 15.0rem;
				--darken: rgba(0, 0, 0, 0.5);
				--dim: rgba(0, 0, 0, 0.2);
				--lighten: rgba(255, 255, 255, 0.6);
			}
			body {
				margin: 0;
				padding: 0;
				background-color: black;
				color: black;
			}
			
			a {
				color: #000;
			}
			
			#viewer {
				width: 100%;
				position: absolute;
				margin: 0;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
			}
			#viewer #mainImage {
				position: relative;
				object-fit: contain;
				height: 100%;
				width: 100%;
				margin:auto;
			}
			
			#prevImageButton, #nextImageButton {
				width: 50%;
				height: 100%;
				position: absolute;
				margin: 0;
				top: 0;
				bottom: 0;
			}
			#prevImageButton {
				left: 0;
				cursor: default;
			}
			#nextImageButton {
				right: 0;
				cursor: default;
			}
			
			.fadeOut {
				opacity: 0.0;
				animation: fade 3s linear;
			}
			@keyframes fade {
				0%,50% { opacity: 1.0; }
				100% { opacity: 0.0; }
			}				
			.fadeOut:hover {
				opacity: 1.0;
			}
			
			#userDisplay {
				display: block;
				position: absolute;
				top: 0;
				right: 0;
				border-radius: 0 0 0 0.5rem;
				background-color: rgba(255, 255, 255, 0.6);
				padding: 0.25rem 0.25rem 0.25rem 0.5rem;
			}
			#userDisplay:hover {
				background-color: #ddd;
			}
			#summaryDisplay {
				display: none;
				position: absolute;
				height: 1.2rem;
				bottom: 0;
				left: 0;
				border-bottom: 1px solid var(--darken);
				border-radius: 0 0.5rem 0 0;
				padding: 0.25rem 0.5rem 0.25rem 0.25rem;
				background-color: var(--lighten);
				cursor: pointer;
			}
			
			#buttonDownload {
				display: none;
				position: absolute;
				bottom: 0;
				right: 0;
				border: none;
				border-radius: 0.5em;
				width: 1.8em;
				height: 1.8em;
				margin: 10px;
				background-color: var(--lighten);
				font-size: 1.5rem;
				line-height: 1.8em;
				text-align: center;
				text-decoration: none;
				cursor: pointer;
			}
			#buttonDownload:hover {
				background-color: #ddd;
			}
			.small #summaryDisplay, .small #buttonDownload {
				bottom: calc(var(--displayHeightSmall) + 1px);
			}
			.large #summaryDisplay, .large #buttonDownload {
				bottom: calc(var(--displayHeightLarge) + 1px);
			}
			
			#infoWindow {
				display: none;
				position: absolute;
				height: var(--displayHeightSmall);
				bottom: 0;
				left: 0;
				right: 0;
				background-color: var(--lighten);
				font-size: 0.8rem;
				color: black;
			}
			.large #infoWindow {
				height: var(--displayHeightLarge);
			}
			#infoWindowTabs {
				position: absolute;
				top: 0;
				left: 0;
			}
			#infoWindowTabs div {
				width: calc(var(--displayHeightSmall) / 3);
				height: calc(var(--displayHeightSmall) / 3 - 2px);
				border-top: 1px solid var(--lighten);
				border-bottom: 1px solid var(--darken);
				border-right: 1px solid var(--darken);
				background-color: var(--dim);
				text-align: center;
				line-height: calc(var(--displayHeightSmall) / 3);
				font-weight: bold;
				cursor: pointer;
			}
			.display {
				display: none;
				height: calc(var(--displayHeightSmall) - 0.4rem - 2px);
				margin: 0 0 0 calc(var(--displayHeightSmall) / 3 + 1px);
				border-top: 1px solid var(--lighten);
				border-bottom: 1px solid var(--darken);
				border-left: 1px solid var(--lighten);
				padding: 0.2rem 0.4rem;
				overflow-y: auto;
			}
			.large .display {
				height: calc(var(--displayHeightLarge) - 0.4rem - 2px);
			}
			.display .displayHeader {
				font-weight: bold;
			}
			.display p {
				margin: 0.1em 0;
			}
			.display ul {
				margin: 0 0 0.1em 0;
				list-style: none;
				padding: 0;
			}
			
			#artistDisplay {
				display: block;
			}
			#artistDisplay p.source {
				margin-top: 0.6em;
			}
			
			#commentsMessages {
				margin-bottom: 0.3rem;
				border-bottom: 1px solid gray;
				padding-bottom: 0.3rem;
			}
			#commentsMessages li {
				margin: 0.2rem 0;
				background-color: var(--lighten);
				padding: 0.1rem 0.3rem;
			}
			#commentsMessages .comment_date { font-size: 0.9em; }
			#commentsMessages .comment_handle { font-style: italic; }
			#commentsMessages .comment_body { }
			
			#commentsSignin {
				display: block;
			}
			#commentsForm {
				display: none;
			}
			#commentsForm label {
			}
			#commentsForm .notice {
				font-style: italic;
			}
			#commentsForm textarea {
				display: block;
				width: 95%;
				height: 3rem;
				margin: auto;
				font-size: 1em;
			}
			#commentsForm button {
				width: 6em;
				margin: 0.5em 0.3em;
				font-size: 0.8em;
				font-weight: bold;
				cursor: pointer;
			}
			
			#errorWindow {
				display: none;
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
			}
			#errorWindow>div {
				background-color: #fff;
				margin: 3rem auto;
				border-radius: 1rem;
				width: 40rem;
				padding: 2rem;
				color: #c00;
			}
			#errorTitle {
				font-size: 3rem;
				text-align: center;
			}
			#errorMessage {
				margin: 1rem 2rem;
				font-size: 2rem;
				text-align: left;
			}
		</style>
	</head>
	<body>
		<div id="viewer">
			<img id="mainImage" />
		</div>
		<div id="prevImageButton" onClick="prevImage()"></div>
		<div id="nextImageButton" onClick="nextImage()"></div>
		<div id="userDisplay" class="fadeOut"><a href="https://auth.artintelligence.gallery/oauth2/authorize?client_id=43hitjgtpit8ijnfh9pfm99bg3&response_type=code&scope=email+openid+phone&redirect_uri=https://dev.artintelligence.gallery/latest">Sign In</a></div>
		<div id="summaryDisplay" onClick="toggleDisplays()">Loading...</div>
		<a id="buttonDownload" class="fadeOut" href="">&#x2913;</a>
		<div id="infoWindow">
			<div id="infoWindowTabs">
				<div id="artistTab" onClick="selectArtistTab()">&#x1F464;</div>
				<div id="commentsTab" onClick="selectCommentsTab()">&#x1F5E8;</div>
				<div id="infoTab" onClick="selectInfoTab()">&#x2139;</div>
			</div>
			<div id="artistDisplay" class="display">Loading...</div>
			<div id="commentsDisplay" class="display">
				<div id="commentsMessages">Loading...</div>
				<div id="commentsSignin">
					<a href="https://auth.artintelligence.gallery/oauth2/authorize?client_id=43hitjgtpit8ijnfh9pfm99bg3&response_type=code&scope=email+openid+phone&redirect_uri=https://dev.artintelligence.gallery/latest">Sign in</a> to post comments.
				</div>
				<form id="commentsForm">
					<label for="comment">Post a comment</label> <span class="notice">(Keep it clean and be nice. Offensive comments will be removed.)</span><br>
					<textarea id="commentTextarea" name="comment" oninput="enableCommentButton()"></textarea>
					<button id="commentButton" class="button" onClick="saveComment()" disabled>Post</button>
				</form>
			</div>
			<div id="infoDisplay" class="display">Loading...</div>
		</div>
		<div id="errorWindow">
			<div>
				<h1 id="errorTitle"></h1>
				<div id="errorMessage"></div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		
		// DISPLAY FUNCTIONS
		
		function displayError(title, message) {
			errorTitle.innerText = title;
			errorMessage.innerHTML = message;
			errorWindow.style.display = "block";
		}
		function hideError() {
			errorTitle.innerText = "";
			errorMessage.innerText = "";
			errorWindow.style.display = "none";
		}
		
		function showSummaryDisplay() {
			summaryDisplay.style.display = 'block';
		}
		function hidesummaryDisplay() {
			summaryDisplay.innerText = '';
			summaryDisplay.style.display = 'none';
		}
		function showDownloadButton() {
			if (!kiosk) {
				userDisplay.style.display = 'block';
				buttonDownload.style.display = 'block';
			}
		}
		function hideDownloadButton() {
			userDisplay.style.display = 'none';
			buttonDownload.style.display = 'none';
		}
		
		function setNavButtons() {
			if (viewerMode == 'shuffle') {
				prevImageButton.style.cursor = 'pointer';
				nextImageButton.style.cursor = 'pointer';
			} else {
				prevImageButton.style.cursor = 'w-resize';
				nextImageButton.style.cursor = 'e-resize';
			}
		}
		function unsetNavButtons() {
			prevImageButton.style.cursor = 'default';
			nextImageButton.style.cursor = 'default';
		}
		
		function toggleDisplays() {
			if (displaysStatus == 0) { openDisplays('small'); displaysStatus++; }
			else if (displaysStatus == 1) { openDisplays('large'); displaysStatus++; }
			else { closeDisplays(); displaysStatus = 0; }
		}
		function openDisplays(size) {
			document.body.classList.remove('small');
			document.body.classList.remove('large');
			document.body.classList.add(size);
			infoWindow.style.display = 'block';
		}
		function closeDisplays() {
			infoWindow.style.display = 'none';
			document.body.classList.remove('small');
			document.body.classList.remove('large');
		}
		
		function resetTabs() {
			artistDisplay.style.display = 'none';
			artistTab.style.background = 'var(--dim)';
			commentsDisplay.style.display = 'none';
			commentsTab.style.background = 'var(--dim)';
			infoDisplay.style.display = 'none';
			infoTab.style.background = 'var(--dim)';
		}
		function selectArtistTab() {
			resetTabs();
			artistDisplay.style.display = 'block';
			artistTab.style.background = 'none';
		}
		function selectCommentsTab() {
			resetTabs();
			commentsDisplay.style.display = 'block';
			commentsTab.style.background = 'none';
		}
		function selectInfoTab() {
			resetTabs();
			infoDisplay.style.display = 'block';
			infoTab.style.background = 'none';
		}
		
		
		// DATA FUNCTIONS
		
		function getCurrentId() {
			let fullPath = (window.location.pathname+window.location.search).split('?')[0];
			let pathParts = fullPath.split("/");
			let currentId = null;
			if (/^(latest|viewer.html)$/.test(pathParts[1])) {
				currentId = 'latest';
			} else if (/^\d{10}$/.test(pathParts[1])) {
				currentId = pathParts[1];
			} else {
				displayError('Image not found', 'This URL does not point to a valid image.<br>Redirecting to the <a href="/latest">latest image</a> in 5 seconds.');
// 				setTimeout(redirectToLatest, 5000);
			}
			return currentId;
		}
		
		function redirectToLatest() {
			window.location.replace('/latest');
		}
		
		function prevImage() {
			updatePage(prevId);
		}
		function nextImage() {
			updatePage(nextId);
		}
		function updatePage(id) {
			let urlObj = new URL(window.location.href);
			urlObj.pathname = '/' + id;
// 			console.log('pushState ' + urlObj.pathname);
			window.history.pushState(null, '', urlObj.href);
			loadImage(id);
		}
		
		function updateSummaryDisplay(info) {
			if (!info['artist']['external_url']) {
				info['artist']['external_url'] = 'https://duckduckgo.com/?q=' + info['query-artist_name'] + ' artist bio'
			}
			let html = info.id + ' Inspired by <a href="' + info['artist']['external_url'] + '" target="_blank">' + info['query-artist_name'] + '</a>';
			summaryDisplay.innerHTML = html;
		}
		function updateArtistDisplay(artist) {
			let html = '';
			if (artist.bio) {
				html = '<p><span class="displayHeader">Artist bio:</span> ' + artist.bio + '</p>';
				if (artist['external_url']) {
					let label = artist['external_url'];
					if (/wikipedia/.test(artist['external_url'])) { label = 'Wikipedia'; }
					html += '<p class="source">Source: <a target="_blank" href="' + artist['external_url'] + '">' + label + '</a></p>';
				}
			} else {
				html = '<p>No artist bio on file</p>';
			}
			artistDisplay.innerHTML = html
		}
		function updateCommentsDisplay(comments) {
			let html = ''
			if (comments && comments.length) {
				html += '<ul>';
				let timeFormatOptions = {
					weekday: 'short',
					month: 'short'
				};
				for (let i in comments) {
					comment = comments[i];
					date = new Date(comment['create_time']);
					dateOutput = date.toLocaleString();
					html += '<li><span class="comment_date">' + dateOutput + '</span> – <span class="comment_handle">' + comment['handle'] + '</span>: <span class="comment_body">' + comment['body'] + '</span></li>';
				}
				html += '</ul>';
			} else {
				html += '<p>No comments</p>';
			}
			commentsMessages.innerHTML = html;
			clearCommentForm();
		}
		function enableCommentButton() {
			if (commentTextarea.value.length) {
				commentButton.disabled = false;
				commentButton.style.cursor = 'pointer';
				clearTimeout(timeout);
			} else {
				clearCommentForm();
			}
		}
		function clearCommentForm() {
			commentsDisplay.scrollTop = 0;
			commentTextarea.value = '';
			commentButton.innerText = 'Save';
			commentButton.disabled = true;
			commentButton.style.cursor = 'default';
			clearTimeout(timeout);
			timeout = setTimeout(nextImage, timeoutDuration * 1000);
		}
		
		function updateInfoDisplay(info) {
			let model = info['model'];
			if (info['model_version']) { model += ' v' + info['model_version']; }
			if (info['model_id']) { model += ' (' + info['model_id'] + ')'; }
			
			let score = ' ';
			if (info.score) {
				for (let i = 1; i <= 5; i++) {
					if (info.score >= i) {
						score += '&#x2605;';
					} else {
						score += '&#x2606;';
					}
				}
			}
			if (info.score == 5) { score += " Excellent. You wouldn't think twice about seeing this hanging in a museum or art gallery."; }
			else if (info.score == 4) { score += " Good. Solid art with some minor defects or maybe it's flawless, but mediocre."; }
			else if (info.score == 3) { score += " Ok. Interesting, but has defects."; }
			else if (info.score == 2) { score += " Trash. Bad, worthless, no value whatsoever."; }
			else if (info.score == 1) { score += " FAIL! So bad it's good."; }
			else if (info.score == 0) { score += " Unscored."; }
			
			let fieldMap = [{
				"name": "id",
				"label": "ID"
			}, {
				"name": "engine_label",
				"label": "Engine"
			}, {
				"name": "model",
				"label": "Model",
				"value": model
			}, {
				"name": "score",
				"label": "Score",
				"value": score
			}, {
				"name": "width",
				"label": "Dimensions",
				"value": info['width'] + 'x' + info['height'] + ' (' + info['aspect_ratio'] + ')'
			}, {
				"name": "prompt",
				"label": "Prompt"
			}, {
				"name": "negative_prompt",
				"label": "Negative prompt"
			}, {
				"name": "cfg_scale",
				"label": "CFG scale"
			}, {
				"name": "steps",
				"label": "Steps"
			}, {
				"name": "seed",
				"label": "Seed"
			}];
			
			let html = '<ul>';
			for (let i in fieldMap) {
				field = fieldMap[i];
				if (info[field['name']]) {
					html += '<li><b>' + field['label'] + '</b>: '
					if (field['value']) { html += field['value']; }
					else { html += info[field['name']]; }
					html += '</li>';
				}
			}
			html += '</ul>';
			infoDisplay.innerHTML = html;
		}
		
		function loadImage(id) {
			id = id.toString();
			id = id.replace(/^\//, '');
			
			showSummaryDisplay('Loading...');
			commentsMessages.innerText = 'Loading...';
			hideDownloadButton();
			unsetNavButtons();
			
			let data = Object.assign({}, query);
			if (!data['nsfw']) {
				data['nsfw'] = false;
			}
			if (!data['score'] && !data['exact_score']) {
				data['exact_score'] = 1;
			}
			data['mode'] = viewerMode;
			
			// Load image info
			callURL({
				endpoint: "/api/get/" + id,
				method: "POST",
				"data": data,
				successFunction: displayImage
			});
			
			clearTimeout(timeout);
			timeout = setTimeout(nextImage, timeoutDuration * 1000);
		}
		
		function displayImage(json) {
			let urlObj = new URL(window.location.href);
// 			console.log('urlObj.pathname: ' + urlObj.pathname);
			if (/^\/(latest|viewer.html)/.test(urlObj.pathname) && json['status'] == 'success' && json['image']['id']) {
				urlObj.pathname = '/' + json['image']['id'];
// 				console.log('urlObj.pathname latest ' + urlObj.href);
				window.history.replaceState(null, '', urlObj.href);
			}
			
			if (json['status'] == 'success') {
				if (json['image']) {
					console.log('Image JSON:');
					console.log(json);
					let image = json['image']
					
					// Set display message
					updateSummaryDisplay(image);
					updateArtistDisplay(image['artist']);
					updateInfoDisplay(image);
					
					showSummaryDisplay();
					showDownloadButton();
					
					mainImage.src = `/images/` + image.filename;
					buttonDownload.href = mainImage.src;
					
					// Set nav buttons
					if (viewerMode == 'shuffle') {
						if (json['random_id']) {
							prevId = json['random_id'];
							nextId = json['random_id'];
						}
					} else {
						if (json['newer_id']) { prevId = json['newer_id']; }
						if (json['older_id']) { nextId = json['older_id']; }
					}
					currentId = image.id
					setNavButtons();
					loadAssetInfo();
				} else {
					hideSummaryDisplay();
					hideDownloadButton();
					mainImage.src = `/assets/not-found.png`;
				}
			} else {
				hideSummaryDisplay();
				hideDownloadButton();
				mainImage.src = `/assets/not-found.png`;
			}
		}
		
		
		// ASSET HANDLING
		
		function loadAssetInfo() {
			// Load asset info (comments)
			callURL({
				endpoint: "/api/user/asset/" + currentId,
				method: "GET",
				successFunction: (function (json) {
					console.log('Comments JSON:'); console.log(json);
					updateCommentsDisplay(json['comments']);
				})
			});
		}
		
		function saveComment() {
			commentButton.innerText = 'Saving';
			commentButton.disabled = true;
			commentButton.style.cursor = 'default';
			
			callURL({
				endpoint: "/api/user/asset/" + currentId + "/comment",
				method: "POST",
				data: { "comment": commentTextarea.value },
				useFormEncoding: true,
				successFunction: (function (json) {
					if (json && json['comments'] && json['comments'].length) {
						console.log('Comments JSON:'); console.log(json);
						updateCommentsDisplay(json['comments']);
					} else {
						console.log('Comments JSON: no data');
					}
				})
			});
			event.preventDefault();
		}
		
		// USER HANDLING
		
		function refreshAccessToken() {
			if (refreshInProgress) { console.log('[INFO] Refresh in progress - stopping'); return; }
			
			refreshInProgress = true;
			
			callURL({
				endpoint: "/api/user/refresh",
				method: "POST",
				useFormEncoding: true,
				successFunction: (function (json) {
					console.log('[INFO] Refreshed access token');
					refreshInProgress = false;
					console.log('[INFO] Rerunning delayed calls:'); console.log(failedCalls);
					while (failedCalls.length) {
						callURL(failedCalls.shift());
					}
				}),
				errorFunction: (function (error) {
					// Redirect to sign in or present error?
					console.log('[ERROR] Failed to refresh access token');
				})
			});
		}
		
		function getUserInfo(code) {
			let data = undefined;
			if (code) {
				data = { "code": code }
			}
			callURL({
				method: "GET",
				'endpoint': "/api/user",
				data: data,
				useFormEncoding: true,
				successFunction: (function (json) {
					if (json && json.username) {
						userInfo = json
						console.log('User JSON:'); console.log(userInfo);
						userDisplay.innerHTML = userInfo['username'] + '<br><a href="https://auth.artintelligence.gallery/logout?client_id=43hitjgtpit8ijnfh9pfm99bg3&logout_uri=https://dev.artintelligence.gallery">Sign out</a>';
						commentsSignin.style.display = 'none';
						commentsForm.style.display = 'block';
					} else {
						console.log('User JSON: no data');
						userDisplay.innerHTML =  '<a href="https://auth.artintelligence.gallery/oauth2/authorize?client_id=43hitjgtpit8ijnfh9pfm99bg3&response_type=code&scope=email+openid+phone&redirect_uri=https://dev.artintelligence.gallery/latest">Sign In</a>';
						commentsSignin.style.display = 'block';
						commentsForm.style.display = 'none';
					}
				})
			});
		}
		
/*		
			callURL({
				endpoint: "/api/get_artist",
				method: "POST",
				headers: { "X-Header": "xxxxxxx" },
				data: { "key": "value" },
				useFormEncoding: true,
				successFunction: testSuccessFunction
			});
*/		
		
		function callURL({
			endpoint = undefined,
			method = "GET",
			headers = {},
			data = undefined,
			useFormEncoding = false,
			successFunction = (function (input) { console.log(input); }),
			errorFunction = undefined,
			refreshTokenOn401 = true
		} = {}) {
			
			
			let body = undefined;
			if (useFormEncoding) {
				headers['Content-Type'] = "application/x-www-form-urlencoded";
				if (method == 'GET') {
					if (data) {
						let query = encodeFormData(data);
						endpoint += '?' + query;
					}
				} else {
					body = encodeFormData(data);
				}
			} else {
				headers['Content-Type'] = "application/json";
				body = JSON.stringify(data);
			}
			
			
			payload = {
				"method": method,
				"headers": headers
			}
			console.log(method + ' ' + endpoint);
			if (body) {
				payload['body'] = body;
				console.log(data);
			}
			
			fetch(endpoint, payload)
			.then((response) => {
				if (response.status >= 200 && response.status <= 299) {
					return response.json()
				} else {
					throw Error(response.status)
				}
			})
			.then(successFunction)
			.catch((error) => {
				if (error.message == 401) {
					if (refreshTokenOn401) {
						failedCalls.push({
							"endpoint": endpoint,
							"method": method,
							"headers": headers,
							"data": data,
							"useFormEncoding": useFormEncoding,
							"successFunction": successFunction,
							"refreshTokenOn401": false
						});
						console.log("[INFO] Got a 401! I am going to refresh tokens!");
						refreshAccessToken();
					}
				} else if (errorFunction) {
					errorFunction(error);
				} else {
					console.log("[ERROR] " + error.message);
				}
			});
		}
		
		// body = encodeFormData(data);
		function encodeFormData(data) {
			if (!data) { return; }
			let keyPairs = []
			for (var key in data) {
				let encodedKey = encodeURIComponent(key);
				let encodedValue = encodeURIComponent(data[key]);
				keyPairs.push(encodedKey + "=" + encodedValue);
			}
			if (keyPairs.length) {
				return keyPairs.join("&");
			}
			return;
		}
		
		
		// SETUP
		
		const clientId = "43hitjgtpit8ijnfh9pfm99bg3"
		const mainImage = document.getElementById("mainImage");
		const prevImageButton = document.getElementById("prevImageButton");
		const nextImageButton = document.getElementById("nextImageButton");
		const userDisplay = document.getElementById("userDisplay");
		const summaryDisplay = document.getElementById("summaryDisplay");
		const artistDisplay = document.getElementById("artistDisplay");
		const commentsDisplay = document.getElementById("commentsDisplay");
		const commentsMessages = document.getElementById("commentsMessages");
		const commentsSignin = document.getElementById("commentsSignin");
		const commentsForm = document.getElementById("commentsForm");
		const commentTextarea = document.getElementById("commentTextarea");
		const commentButton = document.getElementById("commentButton");
		const infoDisplay = document.getElementById("infoDisplay");
		const artistTab = document.getElementById("artistTab");
		const commentsTab = document.getElementById("commentsTab");
		const infoTab = document.getElementById("infoTab");
		const buttonDownload = document.getElementById("buttonDownload");
		
		const errorWindow = document.getElementById("errorWindow");
		const errorTitle = document.getElementById("errorTitle");
		const errorMessage = document.getElementById("errorMessage");
		
		var currentId = null;
		var prevId = null;
		var nextId = null;
		var randomId = null;
		var displaysStatus = 0;
		var userInfo;
		var refreshInProgress = false;
		var failedCalls = [];
		
		// Get initial query args and remove code
		const searchParams = new URLSearchParams(window.location.search)
		const code = searchParams.get('code')
		searchParams.delete('code');
		let newRelativePathQuery = window.location.pathname;
		if (searchParams.toString()) { newRelativePathQuery += '?' + searchParams.toString(); }
		history.replaceState(null, '', newRelativePathQuery);
		const query = Object.fromEntries(searchParams)
		
		// Set mode
		var viewerMode = 'sequential';
		if (query['mode'] == 'shuffle') {
			viewerMode = 'shuffle';
		}
		
		// Set kiosk
		var kiosk = true;
		if (!query['kiosk'] || query['kiosk'] != 'true') {
			kiosk = false;
			showDownloadButton();
		}
		
		// Set timeout duration
		var timeout;
		var timeoutDuration = 5 * 60;
		if (/^0$/.test(query['interval'])) {
			timeoutDuration = null;
		} else if (/^\d+$/.test(query['interval'])) {
			timeoutDuration = Number(query['interval']);
			if (timeoutDuration < 5) {
				timeoutDuration = 5
			}
		}
		
		window.addEventListener("popstate", function(e) {
// 			console.log('popstate ' + window.location.pathname);
			loadImage(window.location.pathname);
			event.preventDefault();
		});
		
		// START
		getUserInfo(code);
		
		currentId = getCurrentId();
		
		if (currentId) { loadImage(currentId); }
		
// 		callURL({
// 			endpoint: "/api/user/test401",
// 			method: "POST",
// 			useFormEncoding: true
// 		});
		
	</script>
</html>
